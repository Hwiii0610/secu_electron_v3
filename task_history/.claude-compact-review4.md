# Claude Compact Review 4

## 1. Primary Request

> "현재 프로젝트의 분석데이터 저장방식을 csv 로 처리하고 있습니다. 이를 json으로 변환할 경우의 이점이 있는지 아니면 좀더 나은 방식이 있는지 제안"
> "csv 로 처리되는 모든 코드부분을 확인하고, json 형식으로 일괄 전환. json 스키마의 경우, 추후 수정되거나 변경될 기능이 있으므로 확장성있는 구조로 설계."

사용자의 핵심 요청: 탐지 데이터 저장 형식을 **CSV에서 JSON으로 전면 전환**. 확장 가능한 스키마 설계 및 전체 파이프라인(탐지→저장→로드→렌더링→마스킹) 일괄 적용.

## 2. Technical Concepts

- **기존 문제**: bbox가 CSV에서 문자열로 저장 → 이중 파싱(`JSON.parse`, `ast.literal_eval`) 필요
- **기존 문제**: 프레임별 조회 시 전체 배열 O(n) 필터링 (`maskingLogs.filter()`)
- **기존 문제**: CSV 파싱에 불필요한 XLSX 라이브러리(18.5) 의존
- **기존 문제**: 메타데이터(모델명, 설정, 영상 정보) 저장 불가
- **해결**: JSON 스키마 v1.0.0 설계, 프레임 기반 딕셔너리, 네이티브 배열, maskingLogsMap O(1) 조회

## 3. JSON Schema (v1.0.0)

```json
{
  "schema_version": "1.0.0",
  "metadata": {
    "created_at": "2026-02-10T14:30:00",
    "updated_at": "2026-02-10T15:00:00",
    "generator": "secuwatcher-detector",
    "video": {
      "filename": "example.mp4",
      "width": 1920, "height": 1080,
      "fps": 30.0, "total_frames": 9000
    },
    "detection": {
      "model": "secuwatcher_best.pt",
      "device": "mps",
      "confidence_threshold": 0.5,
      "class_ids": [0, 1, 2],
      "tracker": "auto_tracker.yaml"
    }
  },
  "frames": {
    "150": [
      {
        "track_id": "1_42",
        "bbox": [120, 80, 340, 290],
        "bbox_type": "rect",
        "score": 0.87,
        "class_id": 0,
        "type": 1,
        "object": 1
      }
    ]
  }
}
```

**설계 원칙**:
- `schema_version`: 향후 스키마 변경 시 버전 기반 마이그레이션
- `metadata`: 확장 가능 (새 키 추가 시 기존 리더가 무시)
- `frames`: 프레임 번호를 key → O(1) 조회
- `bbox`: 네이티브 배열 (문자열 파싱 불필요)
- `bbox_type`: `"rect"` 또는 `"polygon"` 명시적 구분
- `score`/`class_id`: nullable (수동 탐지 type 3,4에서는 `null`)

## 4. Files & Code

### 4.1 `secuwatcher_python/detector.py` — JSON 출력 전환

**import 변경**:
```python
# 제거: import pandas as pd, import ast
# 추가: import json
```

**autodetector() / selectdetector()**:
```python
# 변경 전
output_file = os.path.splitext(video)[0] + ".csv"
df = pd.DataFrame(tracking_results)
df.to_csv(output_file, mode='w', header=True, index=False, ...)

# 변경 후
output_file = os.path.splitext(video)[0] + ".json"

# 영상 메타데이터 캡처 추가
video_width = int(cap.get(cv2.CAP_PROP_FRAME_WIDTH))
video_height = int(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))
video_fps = cap.get(cv2.CAP_PROP_FPS)

# tracking_results → 프레임 딕셔너리 변환 → json.dump
frames_dict = {}
for entry in tracking_results:
    fkey = str(entry["frame"])
    frames_dict.setdefault(fkey, []).append({
        "track_id": entry["track_id"],
        "bbox": entry["bbox"],
        "bbox_type": "rect",
        "score": entry["score"],
        "class_id": entry["class_id"],
        "type": entry["type"],
        "object": entry["object"]
    })

output_data = {
    "schema_version": "1.0.0",
    "metadata": { ... },
    "frames": frames_dict
}

with open(output_file, 'w', encoding='utf-8') as f:
    json.dump(output_data, f, ensure_ascii=False, separators=(',', ':'))
```

---

### 4.2 `secuwatcher_python/blur.py` — JSON 리더 + CSV 폴백

```python
# 변경 전
def _find_csv_for_video(video_path): ...  # .csv만 탐색
def _load_mask_logs(csv_path): ...        # pd.read_csv + bbox 문자열 파싱

# 변경 후
def _find_data_file(video_path):    # .json 우선, .csv 폴백
def _load_mask_data(data_path):     # 확장자로 분기
def _load_mask_data_json(json_path):  # json.load → frame_map 직접 구성
def _load_mask_data_csv(csv_path):    # 기존 CSV 리더 유지 (하위 호환)
```

**호출부 변경**:
```python
# 변경 전
csv_path = _find_csv_for_video(video_path)
frame_logs = _load_mask_logs(csv_path)

# 변경 후
data_path = _find_data_file(video_path)
frame_logs = _load_mask_data(data_path)
```

---

### 4.3 `secuwatcher_electron/src/main.js` — IPC 핸들러 4개 교체

| 기존 핸들러 | 새 핸들러 | 핵심 변경 |
|---|---|---|
| `load-csv` | `load-json` | `.json` 우선 탐색, `JSON.parse` 반환, `.csv` 폴백 시 `{ format: 'csv', data }` |
| `save-csv` | `save-json` | `JSON.stringify` + `fs.writeFileSync` |
| `update-csv` | `update-json` | 기존 JSON 읽기 → `frames`에 엔트리 병합 → 저장 |
| `update-filtered-csv` | `update-filtered-json` | 기존 메타데이터 보존, `frames` 전체 교체 |

**중복 경로 방지** 추가:
```javascript
const seen = new Set();
const uniqueCandidates = candidates.filter(p => {
  if (seen.has(p)) return false;
  seen.add(p);
  return true;
});
```

---

### 4.4 `secuwatcher_electron/src/preload.js` — IPC 채널 교체

```javascript
// 변경 전
loadCsv: (payload) => ipcRenderer.invoke('load-csv', payload),
saveCsv: (payload) => ipcRenderer.invoke('save-csv', payload),
updateCsv: (maskingList) => ipcRenderer.invoke('update-csv', maskingList),
updateFilteredCsv: (payload) => ipcRenderer.invoke('update-filtered-csv', payload),

// 변경 후
loadJson: (requestData) => ipcRenderer.invoke('load-json', requestData),
saveJson: (payload) => ipcRenderer.invoke('save-json', payload),
updateJson: (payload) => ipcRenderer.invoke('update-json', payload),
updateFilteredJson: (payload) => ipcRenderer.invoke('update-filtered-json', payload),
```

---

### 4.5 `secuwatcher_electron/src/App.vue` — 핵심 변경 (가장 복잡)

**(A) XLSX 제거**: `import * as XLSX from 'xlsx'` 삭제

**(B) data 속성 추가**:
```javascript
maskingLogsMap: {},  // 프레임별 O(1) 조회용 딕셔너리
dataLoaded: false,   // csvLoaded → dataLoaded 리네이밍
```

**(C) loadCSVFromBackend() → loadDetectionData()**:
```javascript
// 변경 전: XLSX.read(csvText) → XLSX.utils.sheet_to_json()
// 변경 후: window.electronAPI.loadJson() → result.data.frames 직접 순회

// JSON 응답 처리
for (const [frameKey, entries] of Object.entries(frames)) {
  const frameNum = Number(frameKey);
  this.maskingLogsMap[frameNum] = [];
  for (const entry of entries) {
    const logEntry = { frame: frameNum, track_id, bbox, bbox_type, score, class_id, type, object };
    this.maskingLogs.push(logEntry);
    this.maskingLogsMap[frameNum].push(logEntry);
  }
}

// CSV 폴백: parseCSVLegacy(csvText) — 정규식 기반 파싱 (XLSX 불필요)
```

**(D) 프레임 필터링 최적화** (3곳):
```javascript
// 변경 전 (O(n)):
const logs = this.maskingLogs.filter(log => Number(log.frame) === currentFrame);

// 변경 후 (O(1)):
const logs = this.maskingLogsMap[currentFrame] || [];
```

**(E) bbox 파싱 호환성** (6곳):
```javascript
// 변경 전:
const bboxData = JSON.parse(log.bbox);

// 변경 후 (JSON=배열, CSV폴백=문자열 둘 다 지원):
const bboxData = typeof log.bbox === 'string' ? JSON.parse(log.bbox) : log.bbox;
```

**(F) bbox 생성 — 문자열 → 네이티브 배열**:
```javascript
// 변경 전:
bbox = `[${minX}, ${minY}, ${maxX}, ${maxY}]`;  // 문자열
bbox = `[${points}]`;                            // 문자열

// 변경 후:
bbox = [minX, minY, maxX, maxY];                  // 배열
bbox = this.maskingPoints.map(p => [p.x, p.y]);   // 배열
```

**(G) exportMaskingCSVToBackend() → exportDetectionData()**:
```javascript
// window.electronAPI.updateFilteredCsv → updateFilteredJson
// bbox를 네이티브 배열로 전달
```

**(H) sendBatchMaskingsToBackend()**:
```javascript
// window.electronAPI.updateCsv → updateJson
```

**(I) 헬퍼 메서드 추가**:
```javascript
rebuildMaskingLogsMap() { /* maskingLogs → maskingLogsMap 전체 재구성 */ }
addToMaskingLogsMap(entry) { /* 단건 추가 */ }
```

**(J) 삭제 로직에서 updateFilteredCsv → updateFilteredJson** (3곳):
- deleteObjectsByTrackId
- deleteObjectsByType
- toggleObjectState

---

### 4.6 `secuwatcher_electron/src/resources/config.json`

```json
// 변경 전: "updateCsv", "loadCsv", "saveCsv", "updateFiltered"
// 변경 후: "updateJson", "loadJson", "saveJson", "updateFilteredJson"
```

---

### 4.7 `secuwatcher_electron/package.json` — XLSX 제거

```bash
npm uninstall xlsx  # "xlsx": "^0.18.5" 제거
```

---

### 4.8 `secuwatcher_python/main.py` — Swagger 예제 수정

```python
# "VideoPath": "results/detection_output.csv" → ".json"
```

## 5. Errors & Fixes

### JSON 파싱 오류 (탐지 후 로드 시)

```
SyntaxError: Expected ':' after property name in JSON at position 1720801
```

**원인**:
1. `json.dump`가 14MB를 단일 라인으로 출력 → 파일 쓰기 중 프론트엔드가 불완전한 JSON 로드 시도
2. `load-json` 핸들러에서 hintDirA/hintDirB가 같은 경로 → 동일 파일 두 번 파싱 시도

**수정**:
1. `detector.py`: `separators=(',', ':')` 추가 (파일 크기 14% 감소)
2. `main.js`: `Set` 기반 중복 경로 제거
3. `demo1.json`: 재포맷 → Node.js 파싱 정상 확인

## 6. Problem Solving

### 데이터 흐름 전환 전략

```
Phase 1: Python 백엔드 (생산자)
  ① detector.py — JSON 출력
  ② blur.py — JSON 리더 + CSV 폴백

Phase 2: Electron IPC 레이어
  ③ preload.js — 새 채널 정의
  ④ main.js — 새 JSON 핸들러

Phase 3: 프론트엔드
  ⑤ App.vue — JSON 로딩/렌더링/저장 전환

Phase 4: 정리
  ⑥ XLSX 제거 + CSV 코드 정리
```

**순서 근거**: 생산자(detector.py)를 먼저 변경 → blur.py에 CSV 폴백으로 하위 호환 → IPC를 App.vue보다 먼저 준비 → App.vue 전환 시 핸들러가 이미 존재

### 성능 개선

| 항목 | 변경 전 | 변경 후 |
|------|---------|---------|
| 프레임 조회 | `O(n)` filter | `O(1)` Map lookup |
| bbox 파싱 | `JSON.parse` 매번 | 네이티브 배열 직접 사용 |
| CSV 파싱 | XLSX 라이브러리 | `JSON.parse` 내장 |
| 파일 크기 | CSV 텍스트 | JSON compact (유사) |

## 7. User Messages

### 초기 요청
> "현재 프로젝트의 분석데이터 저장방식을 csv 로 처리하고 있습니다. 이를 json으로 변환할 경우의 이점이 있는지 아니면 좀더 나은 방식이 있는지 제안"

### 구현 요청
> "csv 로 처리되는 모든 코드부분을 확인하고, json 형식으로 일괄 전환. json 스키마의 경우, 추후 수정되거나 변경될 기능이 있으므로 확장성있는 구조로 설계. 현재 코드 베이스를 기준으로 기능을 확인후 설계 진행."

### 오류 확인
> "일렉트론 로그 오류 검토" (JSON 파싱 SyntaxError)

## 8. Recent Fixes (2026-02-10)

### 8.1 Proxy 객체 직렬화 오류 해결

**문제**: 선택 객체 지정/미지정 시 Electron IPC에서 "An object could not be cloned" 오류 발생

**원인**: Vue 3의 반응형 객체(`maskingLogs`)가 Proxy로 감싸져 있어 직렬화 불가

**해결** (`App.vue`):
```javascript
// 변경 전:
window.electronAPI.updateFilteredJson({
  videoName: videoName,
  data: this.maskingLogs  // Proxy 객체 → 직렬화 오류
})

// 변경 후 (3곳 적용):
window.electronAPI.updateFilteredJson({
  videoName: videoName,
  data: JSON.parse(JSON.stringify(this.maskingLogs))  // Plain 객체로 변환
})
```

**적용 위치**:
- `setSelectedObject()` (line 4139)
- `deleteObjectByTrackId()` (line 4169)
- `deleteObjectsByType()` (line 4200)

### 8.2 A/D 키 프레임 단위 이동

**변경 전**: A/D 키로 ±10초 이동  
**변경 후**: A/D 키로 ±1프레임 이동

**코드 변경** (`App.vue` line 1341-1352):
```javascript
jumpBackward() {
  if (this.video && this.frameRate > 0) {
    const frameTime = 1 / this.frameRate;
    this.video.currentTime = Math.max(0, this.video.currentTime - frameTime);
  }
},
jumpForward() {
  if (this.video && this.video.duration && this.frameRate > 0) {
    const frameTime = 1 / this.frameRate;
    this.video.currentTime = Math.min(this.video.duration, this.video.currentTime + frameTime);
  }
}
```

## 9. Pending Tasks

- [ ] 자동 탐지 → JSON 생성 → 프론트엔드 로드 → 렌더링 E2E 테스트
- [ ] 선택 탐지 (Event 2) JSON 출력 테스트
- [ ] 수동 마스킹 (type 3,4) 저장/재로드 테스트
- [ ] 내보내기 파이프라인 (탐지 → blur.py 마스킹) 테스트
- [ ] 기존 CSV 파일 폴백 호환성 테스트

## 10. Current Work

**완료된 작업**: CSV → JSON 전면 전환

**수정된 파일** (7개):

| 파일 | 변경 요약 |
|------|-----------|
| `detector.py` | `pd.DataFrame` + `to_csv` → `json.dump`, 메타데이터 포함 |
| `blur.py` | `_find_data_file()` + `_load_mask_data()` 듀얼 리더 |
| `main.js` | 4개 IPC 핸들러 교체 (load/save/update/update-filtered) |
| `preload.js` | JSON IPC 채널 4개 정의 |
| `App.vue` | XLSX 제거, loadDetectionData, maskingLogsMap, bbox 배열화 |
| `config.json` | CSV 엔드포인트 → JSON 엔드포인트 |
| `main.py` | Swagger 예제 확장자 변경 |

**제거된 의존성**: `xlsx` npm 패키지

---
*Generated: 2026-02-10*  
*Updated: 2026-02-10*  
*Skill: claude-compact*
