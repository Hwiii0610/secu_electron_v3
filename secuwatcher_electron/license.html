<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë¼ì´ì„¼ìŠ¤ ì¸ì¦</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        color: #333;
      }

      .license-container {
        background: white;
        border-radius: 12px;
        padding: 40px;
        width: 500px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      .logo {
        text-align: center;
        margin-bottom: 30px;
      }

      .logo h1 {
        font-size: 24px;
        color: #667eea;
        margin-bottom: 8px;
      }

      .logo p {
        font-size: 14px;
        color: #666;
      }

      .section {
        margin-bottom: 25px;
      }

      .section-title {
        font-size: 14px;
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
      }

      .hardware-id-box {
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 12px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .hardware-id-text {
        flex: 1;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        color: #555;
        word-break: break-all;
        user-select: text;
      }

      .export-btn {
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.2s;
        white-space: nowrap;
      }

      .export-btn:hover {
        background: #5568d3;
      }

      .export-btn:active {
        transform: scale(0.95);
      }

      .export-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .input-group {
        margin-bottom: 20px;
      }

      .input-label {
        font-size: 14px;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        display: block;
      }

      .license-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.2s;
        font-family: 'Courier New', monospace;
      }

      .license-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .submit-btn {
        width: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 6px;
        padding: 14px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      .submit-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .message {
        margin-top: 15px;
        padding: 12px;
        border-radius: 6px;
        font-size: 14px;
        display: none;
      }

      .message.show {
        display: block;
      }

      .message.error {
        background: #fee;
        color: #c33;
        border: 1px solid #fcc;
      }

      .message.success {
        background: #efe;
        color: #3c3;
        border: 1px solid #cfc;
      }

      .info-text {
        font-size: 12px;
        color: #888;
        margin-top: 8px;
        line-height: 1.5;
      }

      .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 0.8s linear infinite;
        margin-left: 10px;
      }

      /* íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
      .tab-buttons {
        display: flex;
        gap: 8px;
        margin-bottom: 15px;
        background: #f5f5f5;
        padding: 4px;
        border-radius: 8px;
      }

      .tab-btn {
        flex: 1;
        padding: 10px 16px;
        background: transparent;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        color: #666;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
      }

      .tab-btn:hover {
        color: #667eea;
        background: rgba(102, 126, 234, 0.1);
      }

      .tab-btn.active {
        background: white;
        color: #667eea;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .tab-btn:active {
        transform: scale(0.98);
      }

      /* íƒ­ ì½˜í…ì¸  ìŠ¤íƒ€ì¼ */
      .tab-content {
        display: none;
        animation: fadeIn 0.3s ease-in-out;
      }

      .tab-content.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* íŒŒì¼ ì„ íƒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
      .file-select-btn {
        width: 100%;
        padding: 16px;
        background: #f8f9ff;
        border: 2px dashed #667eea;
        border-radius: 8px;
        color: #667eea;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .file-select-btn:hover {
        background: #eef1ff;
        border-color: #5568d3;
        color: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
      }

      .file-select-btn:active {
        transform: translateY(0);
      }

      /* íŒŒì¼ëª… í‘œì‹œ ìŠ¤íƒ€ì¼ */
      .file-name {
        margin-top: 12px;
        padding: 10px 12px;
        background: #e8f5e9;
        border: 1px solid #a5d6a7;
        border-radius: 6px;
        font-size: 13px;
        color: #2e7d32;
        display: none;
        animation: slideDown 0.3s ease-in-out;
      }

      .file-name:not(:empty) {
        display: block;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          max-height: 0;
          padding-top: 0;
          padding-bottom: 0;
        }
        to {
          opacity: 1;
          max-height: 50px;
          padding-top: 10px;
          padding-bottom: 10px;
        }
      }

      .file-name::before {
        content: 'âœ“ ';
        font-weight: bold;
      }

      /* íŒŒì¼ ì—…ë¡œë“œ ì—ëŸ¬ ìƒíƒœ */
      .file-select-btn.error {
        border-color: #ef5350;
        background: #ffebee;
        color: #c62828;
      }

      .file-select-btn.error:hover {
        border-color: #e53935;
        background: #ffcdd2;
      }

      /* ì§ì ‘ ì…ë ¥ íƒ­ì˜ input ìŠ¤íƒ€ì¼ ì¡°ì • */
      #text-tab .license-input {
        margin-bottom: 10px;
      }

      /* íŒŒì¼ íƒ­ ìŠ¤íƒ€ì¼ */
      #file-tab {
        min-height: 120px;
      }

      /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ í™œì„±í™” ìƒíƒœ */
      .file-select-btn.drag-over {
        background: #e3f2fd;
        border-color: #42a5f5;
        color: #1565c0;
        transform: scale(1.02);
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <div class="license-container">
      <div class="logo">
        <h1>ğŸ” SecuWatcher Export</h1>
        <p>ë¼ì´ì„¼ìŠ¤ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤</p>
      </div>

      <div class="section">
        <div class="section-title">1ï¸âƒ£ í•˜ë“œì›¨ì–´ ID ë‚´ë³´ë‚´ê¸°</div>
        <div class="hardware-id-box">
          <button class="export-btn" id="exportBtn" disabled>ë‚´ë³´ë‚´ê¸°</button>
        </div>
        <p class="info-text">
          âš ï¸ ë°”íƒ•í™”ë©´ì— ì €ì¥ëœ JSON íŒŒì¼ì„ ë¼ì´ì„¼ìŠ¤ ë°œê¸‰ ì‚¬ì´íŠ¸ì— ì—…ë¡œë“œí•˜ì„¸ìš”.
        </p>
      </div>

      <div class="section">
        <div class="section-title">2ï¸âƒ£ ë¼ì´ì„¼ìŠ¤ í‚¤ ì…ë ¥</div>
        
        <!-- íƒ­ ì„ íƒ -->
        <div class="tab-buttons">
          <button class="tab-btn active" data-tab="text">ì§ì ‘ ì…ë ¥</button>
          <button class="tab-btn" data-tab="file">íŒŒì¼ ì—…ë¡œë“œ</button>
        </div>
        
        <!-- ì§ì ‘ ì…ë ¥ íƒ­ -->
        <div class="tab-content active" id="text-tab">
          <input 
            type="text" 
            class="license-input" 
            id="licenseInput" 
            placeholder="ë¼ì´ì„¼ìŠ¤ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
          />
        </div>
        
        <!-- íŒŒì¼ ì—…ë¡œë“œ íƒ­ -->
        <div class="tab-content" id="file-tab">
          <input type="file" id="licenseFile" accept=".txt,.json" style="display:none"/>
          <button class="file-select-btn" onclick="selectLicenseFile()">
            ğŸ“ ë¼ì´ì„¼ìŠ¤ íŒŒì¼ ì„ íƒ
          </button>
          <div id="fileNameDisplay" class="file-name"></div>
        </div>
        
        <button class="submit-btn" id="submitBtn">ì¸ì¦í•˜ê¸°</button>
      </div>

      <div class="message" id="message"></div>
    </div>

    <script>
      let uploadedLicenseFilePath = null; // ì „ì—­ ë³€ìˆ˜ ì¶”ê°€
      let currentHardwareId = '';

      async function selectLicenseFile() {
        try {
          const result = await window.electronAPI.selectLicenseFile();
          
          if (!result.success) {
            if (!result.canceled) {
              showMessage('âŒ íŒŒì¼ ì„ íƒ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
            }
            return;
          }
          
          // íŒŒì¼ ê²½ë¡œ ì €ì¥
          uploadedLicenseFilePath = result.filePath;
          console.log('âœ… íŒŒì¼ ê²½ë¡œ:', uploadedLicenseFilePath); // ë””ë²„ê¹…
          
          // íŒŒì¼ ë‚´ìš© ì²˜ë¦¬
          const trimmedText = result.content.trim();
          let licenseKey = trimmedText;
          
          if (trimmedText.startsWith('{')) {
            try {
              const jsonData = JSON.parse(trimmedText);
              if (jsonData.license) {
                licenseKey = jsonData.license;
                showMessage('âœ“ JSON íŒŒì¼ì—ì„œ ë¼ì´ì„¼ìŠ¤ í‚¤ë¥¼ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤.', 'success');
              }
            } catch (jsonError) {
              console.log('JSON íŒŒì‹± ì‹¤íŒ¨, ì›ë³¸ í…ìŠ¤íŠ¸ ì‚¬ìš©');
            }
          }
          
          document.getElementById('licenseInput').value = licenseKey;
          document.getElementById('fileNameDisplay').textContent = 'ì„ íƒë¨: ' + result.fileName;
          
        } catch (error) {
          showMessage('âŒ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ' + error.message, 'error');
        }
      }

      // í•˜ë“œì›¨ì–´ ID ê°€ì ¸ì˜¤ê¸°
      async function loadHardwareId() {
        try {
          const hwId = await window.electronAPI.getHardwareId();
          currentHardwareId = hwId;
          document.getElementById('exportBtn').disabled = false;
        } catch (error) {
          console.error('í•˜ë“œì›¨ì–´ ID ë¡œë“œ ì‹¤íŒ¨:', error);
          showMessage('í•˜ë“œì›¨ì–´ IDë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        }
      }

      // ë‚´ë³´ë‚´ê¸° ë²„íŠ¼
      document.getElementById('exportBtn').addEventListener('click', async () => {
        const btn = document.getElementById('exportBtn');
        const originalText = btn.textContent;
        
        try {
          btn.disabled = true;
          btn.textContent = 'ë‚´ë³´ë‚´ëŠ” ì¤‘...';
          
          const result = await window.electronAPI.exportHardwareId(currentHardwareId);
          
          if (result.success) {
            btn.textContent = 'âœ“ ë‚´ë³´ë‚´ê¸° ì™„ë£Œ';
            showMessage(`âœ… íŒŒì¼ì´ ë°”íƒ•í™”ë©´ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n${result.fileName}`, 'success');
            
            setTimeout(() => {
              btn.textContent = originalText;
              btn.disabled = false;
            }, 3000);
          } else {
            throw new Error(result.error || 'ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨');
          }
        } catch (error) {
          showMessage('âŒ íŒŒì¼ ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
          btn.textContent = originalText;
          btn.disabled = false;
        }
      });

      // ë¼ì´ì„¼ìŠ¤ ì¸ì¦
      document.getElementById('submitBtn').addEventListener('click', async () => {
        const licenseKey = document.getElementById('licenseInput').value.trim();
        
        if (!licenseKey) {
          showMessage('ë¼ì´ì„¼ìŠ¤ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error');
          return;
        }

        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'ì¸ì¦ ì¤‘...<span class="loading"></span>';

        try {
          // ë¼ì´ì„¼ìŠ¤ íŒŒì¼ ê²½ë¡œë„ í•¨ê»˜ ì „ë‹¬
          const result = await window.electronAPI.validateLicense(licenseKey, uploadedLicenseFilePath);
          
          if (result.success) {
            showMessage('âœ… ë¼ì´ì„¼ìŠ¤ ì¸ì¦ ì„±ê³µ! í”„ë¡œê·¸ë¨ì„ ì‹œì‘í•©ë‹ˆë‹¤...', 'success');
          } else {
            showMessage('âŒ ' + (result.error || 'ë¼ì´ì„¼ìŠ¤ ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'), 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = 'ì¸ì¦í•˜ê¸°';
          }
        } catch (error) {
          showMessage('âŒ ì˜¤ë¥˜: ' + error.message, 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = 'ì¸ì¦í•˜ê¸°';
        }
      });

      // íƒ­ ì „í™˜
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(btn.dataset.tab + '-tab').classList.add('active');
        });
      });
      
      // íŒŒì¼ ì„ íƒ
      document.getElementById('licenseFile').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (file) {
        try {
          const text = await file.text();
          const trimmedText = text.trim();
          
          // íŒŒì¼ ê²½ë¡œ ì €ì¥ (Electronì—ì„œëŠ” file.path ì‚¬ìš© ê°€ëŠ¥)
          uploadedLicenseFilePath = file.path;
          
          console.log('íŒŒì¼ ê²½ë¡œ:', uploadedLicenseFilePath);

          let licenseKey = trimmedText;
          if (trimmedText.startsWith('{')) {
            try {
              const jsonData = JSON.parse(trimmedText);
              if (jsonData.license) {
                licenseKey = jsonData.license;
              }
            } catch (jsonError) {
              console.log('JSON íŒŒì‹± ì‹¤íŒ¨, ì›ë³¸ í…ìŠ¤íŠ¸ ì‚¬ìš©');
            }
          }
          
          document.getElementById('licenseInput').value = licenseKey;
          document.getElementById('fileNameDisplay').textContent = 'ì„ íƒë¨: ' + file.name;
        } catch (error) {
          showMessage('âŒ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ' + error.message, 'error');
        }
      }
    });

      // Enter í‚¤ë¡œ ì œì¶œ
      document.getElementById('licenseInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          document.getElementById('submitBtn').click();
        }
      });

      // ë©”ì‹œì§€ í‘œì‹œ
      function showMessage(text, type) {
        const messageEl = document.getElementById('message');
        messageEl.textContent = text;
        messageEl.className = 'message show ' + type;
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ í•˜ë“œì›¨ì–´ ID ê°€ì ¸ì˜¤ê¸°
      loadHardwareId();
    </script>
  </body>
</html>